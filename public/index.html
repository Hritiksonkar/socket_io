<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1>Tic Tac Toe</h1>
        <a href="/chat.html" class="nav-link" style="position: absolute; top: 1.5rem; right: 1.5rem;">
            ðŸ’¬ Global Chat
        </a>

        <!-- Login Screen -->
        <div id="login-screen">
            <p style="color: var(--text-muted); margin-bottom: 1rem;">Enter your email to connect</p>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <input type="email" id="email-input" placeholder="your@email.com" autocomplete="off">
                <button id="login-btn">Connect</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden">
            <div id="user-display" class="user-badge"></div>

            <div class="online-users-panel">
                <h4>Online Players:</h4>
                <ul id="online-users-list">
                    <!-- List populated by JS -->
                </ul>
            </div>

            <h3 style="margin: 1.5rem 0 1rem 0;">Start a Game</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <input type="email" id="opponent-email-input" placeholder="Opponent's Email" autocomplete="off">
                <button id="play-btn">Play</button>
            </div>
            <div id="lobby-message"></div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div id="players-info">
                <span id="p1-display" class="player-badge">You: X</span>
                <span id="p2-display" class="player-badge">Opponent: O</span>
            </div>
            <div id="game-board">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
            <div id="status">Waiting for move...</div>
            <button id="reset-btn" class="hidden" style="margin-top: 1rem; background: var(--danger);">Back to
                Lobby</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            transports: ['websocket'],
            upgrade: false
        });

        socket.on("connect_error", (err) => {
            console.error("Connection Error:", err);
            if (document.getElementById('lobby-message')) {
                document.getElementById('lobby-message').textContent = "Connection failed. Please refresh or check your internet.";
            }
        });

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');

        const emailInput = document.getElementById('email-input');
        const loginBtn = document.getElementById('login-btn');
        const userDisplay = document.getElementById('user-display');

        const opponentInput = document.getElementById('opponent-email-input');
        const playBtn = document.getElementById('play-btn');
        const lobbyMessage = document.getElementById('lobby-message');

        const cells = document.querySelectorAll('.cell');
        const statusDiv = document.getElementById('status');
        const resetBtn = document.getElementById('reset-btn');
        const p1Display = document.getElementById('p1-display');
        const p2Display = document.getElementById('p2-display');

        const onlineUsersList = document.getElementById('online-users-list');

        let myEmail = '';
        let mySymbol = '';
        let isMyTurn = false;

        // Login Logic
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value.trim().toLowerCase();
            if (!email) return;
            myEmail = email;
            socket.emit('register', email);
            loginScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            userDisplay.textContent = `Connected as: ${email}`;
        });

        // Online Users Update
        socket.on('users_online', (users) => {
            onlineUsersList.innerHTML = '';
            users.forEach(user => {
                if (user === myEmail) return; // Don't show self or show meaningfully
                const li = document.createElement('li');
                li.textContent = user;
                li.style.cursor = 'pointer';
                li.title = 'Click to challenge';
                li.onclick = () => {
                    opponentInput.value = user;
                };
                onlineUsersList.appendChild(li);
            });
            if (onlineUsersList.children.length === 0) {
                const li = document.createElement('li');
                li.textContent = "No one else is online...";
                li.style.color = "#64748b";
                li.style.listStyle = "none";
                onlineUsersList.appendChild(li);
            }
        });

        // Challenge Logic
        playBtn.addEventListener('click', () => {
            const opponentEmail = opponentInput.value.trim().toLowerCase();
            if (!opponentEmail || opponentEmail === myEmail) {
                lobbyMessage.textContent = "Please enter a valid opponent email (not your own).";
                return;
            }
            socket.emit('challenge', { opponentEmail });
            lobbyMessage.textContent = "Searching for opponent...";
        });

        socket.on('challenge_error', (msg) => {
            lobbyMessage.textContent = msg;
        });

        // Game Start
        socket.on('game_start', ({ gameId, symbol, opponent }) => {
            // Reset UI
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            resetBtn.classList.add('hidden');
            cells.forEach(c => {
                c.textContent = '';
                c.classList.remove('x', 'o');
            });

            mySymbol = symbol;
            isMyTurn = symbol === 'X'; // X starts first

            p1Display.textContent = `You: ${symbol}`;
            p2Display.textContent = `Opponent: ${symbol === 'X' ? 'O' : 'X'} (${opponent})`;

            updateStatus();
        });

        function updateStatus() {
            if (isMyTurn) {
                statusDiv.textContent = "Your Turn";
                statusDiv.style.color = "var(--accent-color)";
            } else {
                statusDiv.textContent = "Opponent's Turn";
                statusDiv.style.color = "#94a3b8";
            }
        }

        // Gameplay
        cells.forEach(cell => {
            cell.addEventListener('click', () => {
                if (!isMyTurn || cell.textContent !== '') return;

                const index = cell.dataset.index;
                socket.emit('make_move', { index });
            });
        });

        socket.on('move_made', ({ index, symbol }) => {
            const cell = cells[index];
            cell.textContent = symbol;
            cell.classList.add(symbol.toLowerCase());

            // Toggle turn
            isMyTurn = (symbol !== mySymbol);
            updateStatus();
        });

        socket.on('game_over', ({ winner, winningLine }) => {
            isMyTurn = false;
            if (winner === 'draw') {
                statusDiv.textContent = "Game Draw!";
                statusDiv.style.color = "white";
            } else {
                if (winner === mySymbol) {
                    statusDiv.textContent = "You Won! ðŸŽ‰";
                    statusDiv.style.color = "#4ade80"; // green
                } else {
                    statusDiv.textContent = "You Lost! ðŸ’€";
                    statusDiv.style.color = "#ef4444"; // red
                }
            }
            resetBtn.classList.remove('hidden');
        });

        socket.on('opponent_left', () => {
            statusDiv.textContent = "Opponent disconnected.";
            statusDiv.style.color = "#ef4444";
            isMyTurn = false;
            resetBtn.classList.remove('hidden');
        });

        resetBtn.addEventListener('click', () => {
            gameScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            lobbyMessage.textContent = '';
            opponentInput.value = '';
        });

    </script>
</body>

</html>